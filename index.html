<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hand Nebula - Main</title>
    <style>
        body { margin: 0; background: #000; color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 1000;
        }
        button {
            padding: 15px 40px; font-size: 20px; cursor: pointer;
            background: #00f2ff; color: black; border: none; border-radius: 50px;
            font-weight: bold; box-shadow: 0 0 20px rgba(0,242,255,0.4);
        }
        #ui { position: absolute; top: 20px; left: 20px; z-index: 10; pointer-events: none; }
        #preview {
            position: absolute; bottom: 20px; right: 20px; width: 220px; height: 160px;
            border: 2px solid #00f2ff; border-radius: 12px; overflow: hidden; background: #111;
        }
        canvas#output_canvas { width: 100%; height: 100%; transform: scaleX(-1); }
        video { display: none; }
        .stat { color: #00f2ff; font-weight: bold; text-shadow: 0 0 10px rgba(0,242,255,0.5); }
    </style>
</head>
<body>

    <div id="overlay">
        <h1>Hand Nebula</h1>
        <p>Control the universe with your gestures.</p>
        <button id="start-btn">START EXPERIENCE</button>
    </div>

    <div id="ui">
        <h2>Shape: <span id="shape-name" class="stat">HEART</span></h2>
        <p>Action: <span id="action-status" class="stat">Waiting...</span></p>
        <small>Pinch to Attract | Move hand High/Low to switch shapes</small>
    </div>

    <div id="preview"><canvas id="output_canvas"></canvas></div>
    <video id="input_video"></video>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <script type="module">
        import * as THREE from 'three';

        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const PARTICLE_COUNT = 15000;

        let currentShape = 'HEART';
        let handX = 0, handY = 0, isPinching = false;

        // --- SHAPE EQUATIONS ---
        const getTargetPoint = (i, shape) => {
            const t = (i / PARTICLE_COUNT) * Math.PI * 2 + Math.random();
            if (shape === 'HEART') {
                const x = 16 * Math.pow(Math.sin(t), 3);
                const y = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
                return { x: x * 0.8, y: y * 0.8, z: (Math.random()-0.5)*5 };
            } else if (shape === 'SATURN') {
                if (i % 4 === 0) { 
                    const phi = Math.acos(-1 + (2 * i) / PARTICLE_COUNT);
                    const theta = Math.sqrt(PARTICLE_COUNT * Math.PI) * phi;
                    return { x: 8 * Math.cos(theta) * Math.sin(phi), y: 8 * Math.sin(theta) * Math.sin(phi), z: 8 * Math.cos(phi) };
                } else { 
                    const r = 13 + Math.random() * 8;
                    return { x: Math.cos(t
